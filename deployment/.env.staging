# ===================================================================
# TNE Catalyst - Staging Environment Configuration
# ===================================================================
# Use this for CANARY TESTING (5% of production traffic)
#
# Usage:
#   docker compose -f docker-compose-split.yml up -d
#
# Purpose: Test new features/configs with real traffic before full rollout
# Last Updated: 2025-01-13
# ===================================================================

# -------------------------------------------------------------------
# SERVER CONFIGURATION
# -------------------------------------------------------------------

# Same URL as production (traffic split happens at nginx)
PBS_HOST_URL=https://catalyst.springwire.ai

# Internal port (behind nginx reverse proxy)
PBS_PORT=8000

# -------------------------------------------------------------------
# DATABASE CONFIGURATION (PostgreSQL)
# -------------------------------------------------------------------

# Uses same database as production
# Consider separate DB if you need to test schema changes
DB_HOST=postgres
DB_PORT=5432
DB_NAME=catalyst_production
DB_USER=catalyst_prod
DB_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE

# SSL mode
DB_SSL_MODE=require

# Connection pool (smaller than production - only 5% traffic)
DB_MAX_OPEN_CONNS=25
DB_MAX_IDLE_CONNS=10
DB_CONN_MAX_LIFETIME=600s

# -------------------------------------------------------------------
# REDIS CONFIGURATION
# -------------------------------------------------------------------

# IMPORTANT: Uses separate Redis instance (redis-staging)
# Keeps staging data isolated from production
REDIS_HOST=redis-staging
REDIS_PORT=6379
REDIS_PASSWORD=CHANGE_ME_REDIS_PASSWORD
REDIS_DB=0

# Redis pool settings (smaller pool for 5% traffic)
REDIS_POOL_SIZE=20
REDIS_IDLE_TIMEOUT=300s
REDIS_POOL_TIMEOUT=4s

# Redis key TTL defaults
REDIS_AUCTION_TTL=300
REDIS_CACHE_TTL=3600

# -------------------------------------------------------------------
# IDR (INTELLIGENT DEMAND ROUTER) - TESTING
# -------------------------------------------------------------------

# Test IDR in staging before enabling in production
IDR_ENABLED=false  # Change to true to test IDR

# IDR service URL
IDR_URL=https://idr.catalyst.springwire.ai

# IDR timeout and retry settings
IDR_TIMEOUT=500ms
IDR_RETRY_ATTEMPTS=3
IDR_FALLBACK_ENABLED=true

# -------------------------------------------------------------------
# IVT (INVALID TRAFFIC) DETECTION - TESTING
# -------------------------------------------------------------------

# TEST AGGRESSIVE IVT BLOCKING HERE FIRST
# If blocking works well in staging, enable in production
IVT_BLOCKING_ENABLED=true  # Test blocking with 5% traffic

# Test stricter country restrictions
# Example: Only allow US, UK, Canada
IVT_ALLOWED_COUNTRIES=US,GB,CA

# Enable all IVT checks
IVT_CHECK_USER_AGENT=true
IVT_CHECK_IP_REPUTATION=true
IVT_CHECK_GEO_MISMATCH=true
IVT_CHECK_SUSPICIOUS_PATTERNS=true

# More aggressive threshold for testing
# Lower = stricter detection
IVT_SUSPICIOUS_THRESHOLD=0.6

# -------------------------------------------------------------------
# CORS (CROSS-ORIGIN RESOURCE SHARING)
# -------------------------------------------------------------------

# Same CORS policy as production
CORS_ALLOWED_ORIGINS=https://yourpublisher.com,https://*.yourpublisher.com

# CORS settings
CORS_ALLOW_CREDENTIALS=true
CORS_MAX_AGE=3600

# -------------------------------------------------------------------
# AUCTION CONFIGURATION
# -------------------------------------------------------------------

# Same auction settings as production
AUCTION_TIMEOUT=2s
AUCTION_MAX_BIDDERS=15
AUCTION_PARALLEL_BIDDING=true

# -------------------------------------------------------------------
# RATE LIMITING
# -------------------------------------------------------------------

# Slightly lower limits (only 5% of traffic)
RATE_LIMIT_GENERAL=50
RATE_LIMIT_AUCTION=25
RATE_LIMIT_BURST=25

# -------------------------------------------------------------------
# LOGGING
# -------------------------------------------------------------------

# INFO level logging (debug creates too much noise and performance overhead)
LOG_LEVEL=info  # Same as production for consistency

# JSON format for consistency
LOG_FORMAT=json

# Log everything in staging
LOG_REQUESTS=true
LOG_METRICS=true

# -------------------------------------------------------------------
# SECURITY & HEADERS
# -------------------------------------------------------------------

# Same security settings as production
SECURITY_HSTS_ENABLED=true
SECURITY_CSRF_ENABLED=true
TRUST_PROXY=true

# -------------------------------------------------------------------
# FEATURE FLAGS - TESTING NEW FEATURES
# -------------------------------------------------------------------

# Enable experimental features in staging
# If they work well, enable in production
FEATURE_EXPERIMENTAL_BIDDERS=true
FEATURE_ADVANCED_TARGETING=true
FEATURE_DEBUG_ENDPOINTS=false  # ⚠️ SECURITY: Disabled to prevent info disclosure

# -------------------------------------------------------------------
# MONITORING & PROFILING
# -------------------------------------------------------------------

# ⚠️ SECURITY: Profiling disabled to prevent memory dumps and info disclosure
PPROF_ENABLED=false

# ⚠️ SECURITY: Debug endpoints disabled (use production observability tools instead)
DEBUG_ENDPOINTS=false

# -------------------------------------------------------------------
# PERFORMANCE TUNING
# -------------------------------------------------------------------

# Go runtime settings
GOMAXPROCS=0  # Use all available CPUs
GOGC=100      # Standard GC target

# -------------------------------------------------------------------
# STAGING-SPECIFIC SETTINGS
# -------------------------------------------------------------------

# Mark this as staging environment
ENV_NAME=staging
STAGING_MODE=true

# ⚠️ SECURITY: Debug headers disabled (exposes internal details)
ADD_DEBUG_HEADERS=false

# -------------------------------------------------------------------
# NOTES
# -------------------------------------------------------------------
#
# Staging Environment Purpose:
# 1. Test new IVT rules before production rollout
# 2. Validate experimental bidders with real traffic
# 3. Performance testing of new optimizations
# 4. A/B test configuration changes
# 5. Validate IDR integration
#
# Key Differences from Production:
# ✓ Separate Redis instance (data isolation)
# ✓ More aggressive IVT blocking (test first)
# ✓ Debug logging enabled
# ✓ Experimental features enabled
# ✓ Lower resource allocation (5% traffic)
#
# Testing Workflow:
# 1. Deploy new config to staging (5% traffic)
# 2. Monitor for 24-48 hours
# 3. Compare performance: ./compare-performance.sh
# 4. If good: promote to production
# 5. If bad: rollback and adjust
#
# Rollback Strategy:
# If staging has issues, only 5% of users affected
# Quick rollback: docker compose -f docker-compose.yml up -d
#
# -------------------------------------------------------------------
