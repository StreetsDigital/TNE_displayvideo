# ===================================================================
# TNE Catalyst - Production Environment Configuration
# ===================================================================
# Use this for PRODUCTION DEPLOYMENT on catalyst.springwire.ai
#
# Usage:
#   docker compose --env-file .env.production up -d
#
# Security: Keep this file secure! Contains production credentials.
# Last Updated: 2025-01-13
# ===================================================================

# -------------------------------------------------------------------
# SERVER CONFIGURATION
# -------------------------------------------------------------------

# Production URL - accessible via HTTPS
PBS_HOST_URL=https://catalyst.springwire.ai

# Internal port (behind nginx reverse proxy)
PBS_PORT=8000

# -------------------------------------------------------------------
# DATABASE CONFIGURATION (PostgreSQL)
# -------------------------------------------------------------------

# IMPORTANT: Change these credentials before deployment!
DB_HOST=postgres
DB_PORT=5432
DB_NAME=catalyst_production
DB_USER=catalyst_prod
DB_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE

# SSL mode for production database
# Use "require" at minimum, "verify-full" for maximum security
DB_SSL_MODE=require

# Connection pool settings (optimized for production traffic)
DB_MAX_OPEN_CONNS=100
DB_MAX_IDLE_CONNS=25
DB_CONN_MAX_LIFETIME=600s

# -------------------------------------------------------------------
# REDIS CONFIGURATION
# -------------------------------------------------------------------

# Redis connection (container name from docker-compose.yml)
REDIS_HOST=redis-prod
REDIS_PORT=6379
REDIS_PASSWORD=CHANGE_ME_REDIS_PASSWORD
REDIS_DB=0

# Redis pool settings (production optimized)
REDIS_POOL_SIZE=50
REDIS_IDLE_TIMEOUT=300s
REDIS_POOL_TIMEOUT=4s

# Redis key TTL defaults (in seconds)
REDIS_AUCTION_TTL=300
REDIS_CACHE_TTL=3600

# -------------------------------------------------------------------
# IDR (INTELLIGENT DEMAND ROUTER) - OPTIONAL
# -------------------------------------------------------------------

# Initially disabled - enable once IDR service is deployed
# The system works without IDR, it's an optional ML enhancement
IDR_ENABLED=false

# IDR service URL (update when IDR is deployed)
IDR_URL=https://idr.catalyst.springwire.ai

# IDR timeout and retry settings
IDR_TIMEOUT=500ms
IDR_RETRY_ATTEMPTS=3
IDR_FALLBACK_ENABLED=true

# -------------------------------------------------------------------
# IVT (INVALID TRAFFIC) DETECTION
# -------------------------------------------------------------------

# Start with monitoring only (no blocking)
# Enable blocking after validating detection accuracy
IVT_BLOCKING_ENABLED=false

# Allowed countries (comma-separated ISO codes)
# Examples: US,GB,CA,AU  or * for all countries
IVT_ALLOWED_COUNTRIES=*

# IVT checks (enable all for production monitoring)
IVT_CHECK_USER_AGENT=true
IVT_CHECK_IP_REPUTATION=true
IVT_CHECK_GEO_MISMATCH=true
IVT_CHECK_SUSPICIOUS_PATTERNS=true

# Threshold for suspicious activity (0.0 - 1.0)
# Start conservative (0.8), lower gradually based on data
IVT_SUSPICIOUS_THRESHOLD=0.8

# -------------------------------------------------------------------
# CORS (CROSS-ORIGIN RESOURCE SHARING)
# -------------------------------------------------------------------

# IMPORTANT: Restrict to your publisher domains
# Replace with your actual publisher domains
CORS_ALLOWED_ORIGINS=https://yourpublisher.com,https://*.yourpublisher.com

# CORS settings
CORS_ALLOW_CREDENTIALS=true
CORS_MAX_AGE=3600

# -------------------------------------------------------------------
# AUCTION CONFIGURATION
# -------------------------------------------------------------------

# Auction timeout (max time to wait for bids)
# Balance between bid response quality and page load time
AUCTION_TIMEOUT=2s

# Maximum bidders to call per auction
AUCTION_MAX_BIDDERS=15

# Enable parallel bidding for performance
AUCTION_PARALLEL_BIDDING=true

# -------------------------------------------------------------------
# RATE LIMITING
# -------------------------------------------------------------------

# Rate limit settings (requests per second)
# Adjust based on expected traffic and server capacity
RATE_LIMIT_GENERAL=100
RATE_LIMIT_AUCTION=50

# Burst allowance (spike tolerance)
RATE_LIMIT_BURST=50

# -------------------------------------------------------------------
# LOGGING
# -------------------------------------------------------------------

# Log level: info (production) or warn (less verbose)
# Use "debug" temporarily for troubleshooting
LOG_LEVEL=info

# Log format: json (machine-readable, for log aggregation)
LOG_FORMAT=json

# Enable request logging (useful for analytics)
LOG_REQUESTS=true

# Enable performance metrics logging
LOG_METRICS=true

# -------------------------------------------------------------------
# SECURITY & HEADERS
# -------------------------------------------------------------------

# Enable security features
SECURITY_HSTS_ENABLED=true
SECURITY_CSRF_ENABLED=true

# Trust proxy headers (nginx reverse proxy)
TRUST_PROXY=true

# -------------------------------------------------------------------
# FEATURE FLAGS
# -------------------------------------------------------------------

# Disable experimental features in production
FEATURE_EXPERIMENTAL_BIDDERS=false
FEATURE_ADVANCED_TARGETING=true
FEATURE_DEBUG_ENDPOINTS=false

# -------------------------------------------------------------------
# MONITORING & PROFILING
# -------------------------------------------------------------------

# Disable pprof in production (security risk)
PPROF_ENABLED=false

# Disable debug endpoints
DEBUG_ENDPOINTS=false

# -------------------------------------------------------------------
# BACKUP CONFIGURATION
# -------------------------------------------------------------------

# Automated backup schedule (cron format)
# Default: Daily at 2 AM UTC
BACKUP_CRON=0 2 * * *

# Backup retention policy
BACKUP_RETENTION_DAYS=7
BACKUP_RETENTION_WEEKS=4
BACKUP_RETENTION_MONTHS=3

# S3 Cloud Backup (Optional but recommended for production)
# Run setup-s3-backups.sh to create bucket and get credentials
BACKUP_S3_BUCKET=
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1

# Immediate backup on service start (for testing)
IMMEDIATE_BACKUP=false

# Timezone for backup scheduling
TZ=UTC

# -------------------------------------------------------------------
# PERFORMANCE TUNING
# -------------------------------------------------------------------

# Go runtime settings (optional overrides)
GOMAXPROCS=0  # 0 = use all available CPUs
GOGC=100      # Garbage collection target percentage

# -------------------------------------------------------------------
# NOTES
# -------------------------------------------------------------------
#
# Production Environment Checklist:
# □ Change DB_PASSWORD to strong password
# □ Change REDIS_PASSWORD to strong password
# □ Update CORS_ALLOWED_ORIGINS with real publisher domains
# □ Verify SSL certificates in ./ssl/ directory
# □ Review rate limits based on expected traffic
# □ Monitor IVT detection before enabling blocking
# □ Consider enabling IDR once ML service is ready
#
# Post-Deployment:
# 1. Monitor error logs for first 24 hours
# 2. Validate auction success rates
# 3. Check IVT detection accuracy
# 4. Review performance metrics
# 5. Adjust rate limits if needed
#
# -------------------------------------------------------------------
